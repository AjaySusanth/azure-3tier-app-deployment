name: Deploy to Azure Container Apps
on:
    push:
        branches:
            - main
    workflow_dispatch:
jobs:
    deploy:
        runs-on: ubuntu-latest

        steps:
            - name: Checkout code
              uses: actions/checkout@v4
            
            - name: Log in to Azure
              uses: azure/login@v1
              with:
                creds: ${{ secrets.AZURE_CREDENTIALS }}

            - name: Log in to ACR
              run: |
                az acr login --name ${{ secrets.ACR_NAME }}

            - name: Build and push backend image
              run: docker build -t ${{ secrets.ACR_NAME }}.azurecr.io/backend:${{ github.sha }} ./backend && docker push ${{ secrets.ACR_NAME }}.azurecr.io/backend:${{ github.sha }}
                
            - name: Build and push nginx image
              run: docker build -t ${{ secrets.ACR_NAME }}.azurecr.io/nginx:${{ github.sha }} -f nginx/Dockerfile . && docker push ${{ secrets.ACR_NAME }}.azurecr.io/nginx:${{ github.sha }}

            - name: Deploy backend
              run: |
                az containerapp update \
                  --name ${{ secrets.BACKEND_APP_NAME }} \
                  --resource-group ${{ secrets.RESOURCE_GROUP }} \
                  --image ${{ secrets.ACR_NAME }}.azurecr.io/backend:${{ github.sha }}

            - name: Deploy nginx
              run: |
                az containerapp update \
                  --name ${{ secrets.NGINX_APP_NAME }} \
                  --resource-group ${{ secrets.RESOURCE_GROUP }} \
                  --image ${{ secrets.ACR_NAME }}.azurecr.io/nginx:${{ github.sha }}

            
